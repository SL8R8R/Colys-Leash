# Copilot / AI Agent Instructions — Colys Leash

This file gives focused, actionable guidance for AI coding agents working on the `colys-leash` Foundry VTT module.

Summary
- Type: Foundry VTT module (see `module.json`: `"type": "module"`).
- Primary code: `scripts/leash.js` (single self-contained runtime script).
- Styling: `styles/leash.css`.

Big picture
- This is a small Foundry client module that attaches a "leash" relationship between two tokens. The code runs entirely in the Foundry client (no server backend).
- Key concepts: token Flags (module-scoped), Foundry Hooks lifecycle (`init`, `ready`, `preUpdateToken`, `updateToken`, `renderTokenHUD`, `hoverToken`, `controlToken`, `canvasReady`, `deleteToken`), PIXI graphics for ring visuals, and `canvas.grid.measureDistance` for grid-aware distance.
- Data shape: leash flag stored on a Token document as an object: `{ handlerId, sceneId, distance }`. Use `doc.getFlag(MODULE_ID, 'leash')` and `doc.setFlag(MODULE_ID, 'leash', value)`.

What to look for in the code
- `MODULE_ID` constant and helper wrappers at top of `scripts/leash.js`.
- Settings registration inside `Hooks.once('init', ...)` — keys: `defaultDistance`, `exceedBehavior`, `gmOnly`, `ringVisibility`, `handlerPullMode`.
- Two-step movement logic:
  - `preUpdateToken` enforces/block-or-clamp movement when a leashed token is moved.
  - `updateToken` handles handler movement sessions and applies delta movement to lessees (with defensive `_internalUpdating` to avoid loops).
- Ring visuals: `showRingForPair`, `updateRingPosition`, `removeRingForPair` manipulate `PIXI.Graphics` attached to `canvas.primary`.

Project-specific conventions and gotchas
- Single-file runtime: changes to `scripts/leash.js` are global; be careful to keep initialization guards (`__colys_inited`, `__colys_hooks_registered`).
- Use of flags: all leash state is stored on token documents via `setFlag`/`getFlag` scoped to `MODULE_ID`. Do not invent a parallel storage.
- Avoid infinite update loops: the module uses `_internalUpdating` Set to mark programmatic updates. If you modify movement logic, preserve or extend this mechanism.
- Movement flow split: `preUpdateToken` may cancel or mutate the pending update (return `false` to block). `updateToken` applies subsequent embedded-document updates — keep changes coherent across both hooks.
- Behavior keys: changing `exceedBehavior` or `handlerPullMode` requires touching both the pre-update clamp and the handler-pull code paths.

Integration points and external API
- Foundry APIs used heavily: `game.settings`, `Hooks`, `canvas.grid.measureDistance`, `scene.updateEmbeddedDocuments('Token', updates)`, `ui.notifications`.
- Exposed API: `game.modules.get('colys-leash').api` contains `leash(targetDoc, handlerDoc, distance)` and `unleash(targetDoc)`; prefer these helpers when other code should apply or remove leashes.

Developer workflows
- No build step — edit `scripts/leash.js` and reload Foundry (or restart the client) to see changes.
- To test behavior: enable module in Foundry, open a scene with at least two tokens, use Token HUD → Leash, then move handler and target tokens to verify clamps/drag.
- Debugging: use the Foundry client console (Electron devtools). The module logs with `${MODULE_ID} | ...` prefixes (search for `colys-leash |` in console).

Examples from code
- Flag set example:
```js
await setLeashFlag(targetDoc, { handlerId: handlerDoc.id, sceneId: scene.id, distance });
```
- Settings read example:
```js
game.settings.get('colys-leash', 'exceedBehavior');
```
- Session/loop protection:
```js
if (_internalUpdating.has(tokenDoc.id)) return; // skip programmatic updates
```

When modifying behavior
- If you add new settings affecting movement, update both `preUpdateToken` (for blocking/clamping) and the `updateToken` handler-pull logic.
- If you change the flag schema, update `getLeashFlag`, `setLeashFlag`, and every place that reads the flag (search for `.getFlag(${MODULE_ID}, 'leash')`).
- Update ring management whenever token ids or scene ids change; `canvasReady` / `deleteToken` cleanup must remain intact.

If something is unclear
- Tell me which area you want expanded (movement logic, flags, ring visuals, or testing instructions) and I will iterate.

Last updated: autogenerated — review before large refactors.
